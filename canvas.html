<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="user-scalable=0">
<title>无标题文档</title>
<style>
html,body{
	height:100%;
	width:100%;
}
body{
	padding:0;
	margin:0;
	border:0;
}
</style>
</head>

<body>
<canvas id="canvas"></canvas>
<script>
//创建canvas
var c = document.getElementById("canvas");
var bodyWidth = document.body.clientWidth;
var bodyHeight = document.body.clientHeight;
c.width = bodyWidth;
c.height = bodyHeight;
var ctx = c.getContext("2d");

//基础画点画线函数
function drawPt(x,y)
{
	ctx.fillStyle = "#000000";
	ctx.fillRect(x-3,y-3,6,6);
}
function drawXyPt(dcpx,dcpy)
{
	tmpx1=dcpx*(bodyWidth/20);
	tmpy1=dcpy*(bodyWidth/20);
	tmpx1+=(bodyWidth/2);
	tmpy1=(bodyHeight/2)-tmpy1;
	drawPt(tmpx1,tmpy1);
}
function lineConnect(x1,y1,x2,y2)
{
	ctx.beginPath();
	ctx.moveTo(x1,y1);
	ctx.lineTo(x2,y2);
	ctx.stroke();
	ctx.closePath();
}

//定义相机位置
cameraX = -0.2;
cameraY = 3;
cameraZ = 0.5;

//定义顶点位置
var xArr=new Array(1,5,5,1,1,5,5,1);
var yArr=new Array(1,1,5,5,1,1,5,5);
var zArr=new Array(1,1,1,1,3,3,3,3);

//定义显示缓冲区位置
var xDispArr=new Array();
var yDispArr=new Array();

//定义线的顶点连接
var lineArr=new Array(0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7);

//绘制主程序
function maindraw()
{
	//地心引力部分
	if(cameraY >= 3)
	{
		cameraY -= 0.03;
	}
	//清屏
	ctx.clearRect(0,0,canvas.width,canvas.height);
	//转换顶点X坐标
	for(tmp=0;tmp<8;tmp++)
	{
		tmp1 = xArr[tmp]*1.0-cameraX*1.0;
		tmp2 = zArr[tmp]*1.0+cameraZ*1.0;
		xDispArr[tmp] = tmp1 / tmp2;
	}
	//转换顶点Y坐标
	for(tmp=0;tmp<8;tmp++)
	{
		tmp1 = yArr[tmp]*1.0-cameraY*1.0;
		tmp2 = zArr[tmp]*1.0+cameraZ*1.0;
		yDispArr[tmp] = tmp1 / tmp2;
	}
	//逐个绘制顶点
	for(tmp=0;tmp<8;tmp++)
	{
		drawXyPt(xDispArr[tmp],yDispArr[tmp]);
	}
	//连线
	for(tmp=0;tmp<lineArr.length;tmp+=2)
	{
		tmpx1=xDispArr[lineArr[tmp]]*(bodyWidth/20);
		tmpy1=yDispArr[lineArr[tmp]]*(bodyWidth/20);
		tmpx1+=(bodyWidth/2);
		tmpy1=(bodyHeight/2)-tmpy1;
		tmpx2=xDispArr[lineArr[tmp+1]]*bodyWidth/20;
		tmpy2=yDispArr[lineArr[tmp+1]]*bodyWidth/20;
		tmpx2+=bodyWidth/2;
		tmpy2=bodyHeight/2-tmpy2;
		lineConnect(tmpx1,tmpy1,tmpx2,tmpy2);
	}
	//40毫秒后继续执行maindraw主函数
	setTimeout(maindraw,1);
}

//开始运行maindraw主函数
setTimeout(maindraw,20);

</script>
<script>
//跳跃程序
function jump()
{
	count+=1;
	if(count<=70)
	{
		cameraY += 0.1;
		setTimeout(jump,1);
	}
}
//检测按键按下
window.onkeydown=function(){
	if(event.keyCode == 74){
		//alert('j');
		cameraY = cameraY - 0.1;
	}
	else if(event.keyCode == 65){
		//alert('a');
		cameraX = cameraX - 0.3;
	}
	else if(event.keyCode == 75){
		//alert('k');
		cameraY = cameraY + 0.1;
	}
	else if(event.keyCode == 68){
		//alert('d');
		cameraX = cameraX + 0.3;
	}
	else if(event.keyCode == 87){
		//alert('w');
		cameraZ = cameraZ - 0.04;
	}
	else if(event.keyCode == 83){
		//alert('s');
		cameraZ = cameraZ + 0.04;
	}
	else if (event.keyCode == 32){
		count = 0;
		jump();
	}
}
</script>
<!--触控支持-->
<style>
		.key{
			width:100px;
			height:100px;
			border-radius:50px;
			box-shadow:0 0 10px #000000;
			text-align: center;
			display:table-cell;
			vertical-align: middle;
			font-size:30px;
		}
		#leftbar{
			height:auto;
			width:auto;
			position:absolute;
			top:0;
			left:0;
			padding:10px;
		}
	</style>
	<div id="leftbar">
		<div class="key" id="up">Up</div><br>
        <div class="key" id="down">Down</div><br>
        <div class="key" id="left">Left</div><br>
        <div class="key" id="right">Right</div><br>
        <div class="key" id="jump">Jump</div><br>
	</div>
	<script>
	var status = 0;
	var up = document.getElementById("up");
	var down = document.getElementById("down");
	var left = document.getElementById("left");
	var right = document.getElementById("right");
	var jump = document.getElementById("jump");
	up.addEventListener("touchstart",function(){
		status = 1;
	});
	up.addEventListener("touchend",function()
	{
		status = 0;
	});
	down.addEventListener("touchstart",function(){
		status = 2;
	});
	down.addEventListener("touchend",function()
	{
		status = 0;
	});
	left.addEventListener("touchstart",function(){
		status = 3;
	});
	left.addEventListener("touchend",function()
	{
		status = 0;
	});
	right.addEventListener("touchstart",function(){
		status = 4;
	});
	right.addEventListener("touchend",function()
	{
		status = 0;
	});
	jump.addEventListener("onclick",function(){
		count = 0;
		jump();
	});
	function touchloop(){
		if(status == 1){
			cameraZ = cameraZ - 0.04;
		}else if(status == 2){
			cameraZ = cameraZ + 0.04;
		}
		else if(status == 3){
			cameraX = cameraX - 0.3;
		}
		else if(status == 4)
		{
			cameraX = cameraX + 0.3;
		}
		setTimeout(touchloop,20);
	}
	setTimeout(touchloop,0);
	</script>
</body>
</html>